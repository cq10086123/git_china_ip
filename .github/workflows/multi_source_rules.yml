name: Update Split Rules

# 触发条件：
on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  split-rules:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Process Rules to Separate Files
        run: |
          # =======================================================
          # 1. 定义核心处理函数 (已加入 prefix_only 模式，共五种)
          # =======================================================
          fetch_rule() {
            local url=$1
            local target_file=$2
            local mode=$3
            
            echo "正在处理: $url -> $target_file [模式: $mode]"
            
            # 使用 -f 忽略下载错误，让脚本继续运行
            curl -sL -f "$url" -o temp_data.txt
            
            touch "$target_file"

            # 根据模式处理并追加(>>)到目标文件
            if [ "$mode" == "raw" ]; then
               # 模式 A (raw): 纯 IP -> 加 IP-CIDR, 和 ,no-resolve (用于代理 IP 段)
               awk 'NF {print "IP-CIDR,"$0",no-resolve"}' temp_data.txt >> "$target_file"
            
            elif [ "$mode" == "suffix" ]; then
               # 模式 B (suffix): 缺后缀 -> 补 ,no-resolve
               awk 'NF {print $0",no-resolve"}' temp_data.txt >> "$target_file"
            
            elif [ "$mode" == "prefix" ]; then
               # 模式 D (prefix): 缺前缀 -> 补 IP-CIDR,
               awk 'NF {print "IP-CIDR,"$0}' temp_data.txt >> "$target_file"
            
            elif [ "$mode" == "prefix_only" ]; then
               # 模式 E (新增): 纯 IP -> 仅补 IP-CIDR, (专用于国内 IP 直连)
               awk 'NF {print "IP-CIDR,"$0}' temp_data.txt >> "$target_file"
            
            elif [ "$mode" == "direct" ]; then
               # 模式 C (direct): 格式完美 -> 直接复制
               awk 'NF {print $0}' temp_data.txt >> "$target_file"
            fi
            
            rm -f temp_data.txt
            echo "" >> "$target_file"
          }

          # =======================================================
          # 2. 初始化/清空旧文件 (重要！) 【已修正】使用 rm -f 删除残留文件
          # =======================================================
          # 1. 确保将不再需要的文件彻底从工作目录中移除
          rm -f custom_ip_rules.list 
          
          # 2. 清空目标文件，确保内容从空开始追加
          > china_ip.list
          > yun_fuwuqi.list
          > china_yuming.list

          # =======================================================
          # 3. 配置下载任务 (已修正 URL 和 MODE)
          # =======================================================
          
          # --- 任务组 1: 国内 IP 规则 (china_ip.list) ---
          fetch_rule "https://raw.githubusercontent.com/mayaxcn/china-ip-list/master/chnroute.txt" "china_ip.list" "prefix_only"
          
          # --- 任务组 2: 云服务 IP 规则 (yun_fuwuqi.list) ---
          fetch_rule "https://raw.githubusercontent.com/axpwx/IP-Data/master/provider/aliyun-cidr-ipv4.txt" "yun_fuwuqi.list" "prefix_only"
          fetch_rule "https://raw.githubusercontent.com/axpwx/IP-Data/master/provider/tencent-cidr-ipv4.txt" "yun_fuwuqi.list" "prefix_only"
          fetch_rule "https://raw.githubusercontent.com/axpwx/IP-Data/master/provider/huawei-cidr-ipv4.txt" "yun_fuwuqi.list" "prefix_only"
          fetch_rule "https://raw.githubusercontent.com/axpwx/IP-Data/master/provider/baidu-cidr-ipv4.txt" "yun_fuwuqi.list" "prefix_only"
          
          # --- 任务组 3: 域名规则 (china_yuming.list) ---
          fetch_rule "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/China/China.list" "china_yuming.list" "direct"

          # =======================================================
          # 4. 批量去重与清理 (已添加域名文件跳过过滤逻辑)
          # =======================================================
          echo "正在优化所有列表文件..."
          
          # 遍历当前目录下所有生成的 .list 文件
          for file in *.list; do
            if [ -f "$file" ]; then
              echo "优化文件: $file"
              
              if [ "$file" == "china_yuming.list" ]; then
                # 域名文件：只排序去重
                sort -u "$file" > "${file}.tmp"
                echo "【注意】域名文件已跳过 IP-CIDR 过滤。"
              else
                # IP 文件：排序、去重和 IP-CIDR 过滤
                sort -u "$file" | grep "IP-CIDR" > "${file}.tmp"
              fi
              
              mv "${file}.tmp" "$file"
              echo "优化后总行数: $(wc -l < "$file")"
            fi
          done

      - name: Commit and Push
        run: |
          # 配置 Git 用户信息
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # 添加所有 .list 文件
          git add *.list
          
          # 提交更改 (如果提交成功，则 exit code 为 0；如果无更改，我们允许 exit code 为 0)
          git commit -m "Auto update split rules: $(date +'%Y-%m-%d')" || exit 0
          
          # 推送回仓库
          git push
