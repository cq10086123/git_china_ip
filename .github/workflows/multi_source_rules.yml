name: Update Multi-Source Rules

on:
  schedule:
    - cron: '0 2 * * *' # æ¯å¤©è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:    # æ”¯æŒæ‰‹åŠ¨è¿è¡Œ

permissions:
  contents: write

jobs:
  merge-rules:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Process and Merge Rules
        run: |
          # å®šä¹‰æœ€ç»ˆè¾“å‡ºçš„æ–‡ä»¶å
          OUTPUT_FILE="combined_rules.list"
          # æ¸…ç©º/åˆ›å»ºè¾“å‡ºæ–‡ä»¶
          > "$OUTPUT_FILE"

          # =======================================================
          # å®šä¹‰å¤„ç†å‡½æ•° (ä¸ç”¨æ”¹è¿™é‡Œï¼Œæ”¹ä¸‹é¢çš„è°ƒç”¨åŒºåŸŸå³å¯)
          # å‚æ•°1: URL
          # å‚æ•°2: æ¨¡å¼ (raw / suffix / direct)
          # =======================================================
          process_url() {
            local url=$1
            local mode=$2
            echo "æ­£åœ¨å¤„ç†: $url [æ¨¡å¼: $mode]"
            
            # ä¸‹è½½åˆ°ä¸´æ—¶æ–‡ä»¶ temp_source.txt
            curl -sL "$url" -o temp_source.txt
            
            # æ ¹æ®æ¨¡å¼è¿›è¡Œå¤„ç†å¹¶è¿½åŠ åˆ°è¾“å‡ºæ–‡ä»¶
            if [ "$mode" == "raw" ]; then
               # æ¨¡å¼ A: åŸå§‹ IP -> åŠ å‰åç¼€
               awk 'NF {print "IP-CIDR,"$0",no-resolve"}' temp_source.txt >> "$OUTPUT_FILE"
            
            elif [ "$mode" == "suffix" ]; then
               # æ¨¡å¼ B: å·²æœ‰å‰ç¼€ -> è¡¥åç¼€
               awk 'NF {print $0",no-resolve"}' temp_source.txt >> "$OUTPUT_FILE"
            
            elif [ "$mode" == "direct" ]; then
               # æ¨¡å¼ C: æ ¼å¼å®Œç¾ -> ç›´æ¥å¤åˆ¶
               awk 'NF {print $0}' temp_source.txt >> "$OUTPUT_FILE"
            fi
            
            # å¿…é¡»åŠ ä¸€ä¸ªæ¢è¡Œç¬¦ï¼Œé˜²æ­¢æ–‡ä»¶æœ«å°¾æ²¡æœ‰æ¢è¡Œå¯¼è‡´åˆå¹¶å‡ºé”™
            echo "" >> "$OUTPUT_FILE"
          }

          # =======================================================
          # ğŸš€ é…ç½®åŒºåŸŸï¼šåœ¨è¿™é‡Œæ·»åŠ æ‚¨çš„æ‰€æœ‰é“¾æ¥
          # =======================================================

          # 1. ã€çº¯ IP æ ¼å¼ã€‘ (ä¾‹å¦‚: 1.0.1.0/24)
          #    ä¼šè‡ªåŠ¨å˜æˆ: IP-CIDR,1.0.1.0/24,no-resolve
          process_url "https://example.com/raw_ips.txt" "raw"
          process_url "https://example.com/another_raw.txt" "raw"

          # 2. ã€ç¼ºåç¼€æ ¼å¼ã€‘ (ä¾‹å¦‚: IP-CIDR,1.0.1.0/24)
          #    ä¼šè‡ªåŠ¨å˜æˆ: IP-CIDR,1.0.1.0/24,no-resolve
          process_url "https://example.com/missing_suffix.txt" "suffix"

          # 3. ã€å®Œç¾æ ¼å¼ã€‘ (ä¾‹å¦‚: IP-CIDR,1.0.1.0/24,no-resolve)
          #    ç›´æ¥åˆå¹¶ï¼Œä¸ä¿®æ”¹
          process_url "https://example.com/perfect_list.list" "direct"

          # =======================================================
          # åæœŸå¤„ç†ï¼šå»é‡ä¸æ¸…ç†
          # =======================================================
          
          echo "æ­£åœ¨å»é‡å’Œæ¸…ç†..."
          # 1. sort -u: æ’åºå¹¶å»é‡
          # 2. grep: ç¡®ä¿åªä¿ç•™åŒ…å« IP-CIDR çš„æœ‰æ•ˆè¡Œ
          # 3. è¦†ç›–å›åŸæ–‡ä»¶
          sort -u "$OUTPUT_FILE" | grep "IP-CIDR" > final_temp.list
          mv final_temp.list "$OUTPUT_FILE"
          
          # åˆ é™¤ä¸´æ—¶ä¸‹è½½æ–‡ä»¶
          rm temp_source.txt
          
          echo "å¤„ç†å®Œæˆï¼Œæ€»è¡Œæ•°ï¼š"
          wc -l "$OUTPUT_FILE"

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .
          git commit -m "Update rules: $(date +'%Y-%m-%d')" || echo "No changes"
          git push
