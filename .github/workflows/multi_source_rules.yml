# Run # =======================================================
# NAME: Update Split Rules (修正版)
# 修正内容：精确区分 IP 规则和域名/混合规则的优化逻辑，修复因不当过滤导致的 'exit code 1' 错误。
# =======================================================
name: Update Split Rules

# 触发条件：
on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  split-rules:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Process Rules to Separate Files
        run: |
          # =======================================================
          # 1. 定义核心处理函数 (已加入模式记录)
          # =======================================================
          fetch_rule() {
            local url=$1
            local target_file=$2
            local mode=$3
            
            echo "正在处理: $url -> $target_file [模式: $mode]"
            
            # 【新】：记录目标文件使用的模式 (使用 >> 追加以处理多个 URL 写入同一个目标文件的情况)
            echo "$target_file:$mode" >> file_modes.txt
            
            # 使用 -f 忽略下载错误，让脚本继续运行 (curl 失败时返回非 0 退出码，但由于后续代码可能依赖 temp_data.txt，
            # 最好确保 curl 成功或 temp_data.txt 存在空文件)
            curl -sL -f "$url" -o temp_data.txt || {
              echo "警告：下载 $url 失败，继续处理空文件..."
              touch temp_data.txt # 确保文件存在，即使为空
            }
            
            # 确保目标文件存在
            touch "$target_file"

            # 根据模式处理并追加(>>)到目标文件
            if [ "$mode" == "raw" ]; then
                # 模式 A (raw): 纯 IP -> 加 IP-CIDR, 和 ,no-resolve (用于代理 IP 段)
                awk 'NF {print "IP-CIDR,"$0",no-resolve"}' temp_data.txt >> "$target_file"
            
            elif [ "$mode" == "suffix" ]; then
                # 模式 B (suffix): 缺后缀 -> 补 ,no-resolve (用于域名/混合规则，防止 DNS 泄露)
                # 兼容处理所有非空行
                awk 'NF {print $0",no-resolve"}' temp_data.txt >> "$target_file"
            
            elif [ "$mode" == "prefix" ]; then
                # 模式 D (prefix): 缺前缀 -> 补 IP-CIDR,
                awk 'NF {print "IP-CIDR,"$0}' temp_data.txt >> "$target_file"
            
            elif [ "$mode" == "prefix_only" ]; then
                # 模式 E (新增): 纯 IP -> 仅补 IP-CIDR, (专用于国内 IP 直连)
                awk 'NF {print "IP-CIDR,"$0}' temp_data.txt >> "$target_file"
            
            elif [ "$mode" == "direct" ]; then
                # 模式 C (direct): 格式完美 -> 直接复制
                awk 'NF {print $0}' temp_data.txt >> "$target_file"
            fi
            
            rm -f temp_data.txt
            echo "" >> "$target_file"
          }

          # =======================================================
          # 2. 初始化/清理旧文件 (重要！)
          # =======================================================
          # 1. 删除不再需要的残留文件，并清空模式映射文件
          rm -f custom_ip_rules.list
          > file_modes.txt
          
          # 2. 清空所有目标文件，确保内容从空开始追加
          > china_ip.list
          > yun_fuwuqi.list
          > china_yuming.list
          #> china_Advertising.list
          > china_zhilian.list
          #> china_juyuwang.list

          # =======================================================
          # 3. 配置下载任务 (保持不变，但确保 china_zhilian.list 使用 suffix)
          # =======================================================
          
          # --- 任务组 1: 国内 IP 规则 (china_ip.list) ---
          fetch_rule "https://raw.githubusercontent.com/mayaxcn/china-ip-list/master/chnroute.txt" "china_ip.list" "prefix_only"
          
          # --- 任务组 2: 云服务 IP 规则 (yun_fuwuqi.list) ---
          fetch_rule "https://raw.githubusercontent.com/axpwx/IP-Data/master/provider/aliyun-cidr-ipv4.txt" "yun_fuwuqi.list" "raw"
          fetch_rule "https://raw.githubusercontent.com/axpwx/IP-Data/master/provider/tencent-cidr-ipv4.txt" "yun_fuwuqi.list" "raw"
          fetch_rule "https://raw.githubusercontent.com/axpwx/IP-Data/master/provider/huawei-cidr-ipv4.txt" "yun_fuwuqi.list" "raw"
          fetch_rule "https://raw.githubusercontent.com/axpwx/IP-Data/master/provider/baidu-cidr-ipv4.txt" "yun_fuwuqi.list" "raw"

          # --- 任务组 3: 域名/混合规则 (使用 suffix 模式添加 ,no-resolve) ---
          # china_yuming.list: 添加 ,no-resolve
          fetch_rule "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/China/China.list" "china_yuming.list" "suffix"
          # china_zhilian.list: 使用 suffix 模式添加 ,no-resolve（解决 DNS 泄露需求）
          fetch_rule "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Direct/Direct.list" "china_zhilian.list" "suffix"

          # =======================================================
          # 4. 批量去重与清理 (核心修正：精确判断是否执行 IP-CIDR 过滤)
          # =======================================================
          echo "正在优化所有列表文件..."
          
          # 遍历 file_modes.txt 中的每一行 (文件名:模式)
          # 注意：使用 sort -u file_modes.txt | while IFS=: read -r file mode; do ...
          # 可以避免对同一个文件（如 yun_fuwuqi.list）多次执行优化，提高效率。
          sort -u file_modes.txt | while IFS=: read -r file mode; do
            if [[ -f "$file" ]]; then
              echo "优化文件: $file"
              
              # 仅对纯 IP 规则文件（raw, prefix, prefix_only）执行 IP-CIDR 过滤
              if [ "$mode" == "raw" ] || [ "$mode" == "prefix" ] || [ "$mode" == "prefix_only" ]; then
                # 纯 IP 文件：排序、去重和 IP-CIDR 过滤
                sort -u "$file" | grep "IP-CIDR" > "${file}.tmp"
                echo "【注意】纯 IP 文件已执行 IP-CIDR 过滤。"
              else
                # 域名或混合规则文件（suffix, direct）：只排序去重
                sort -u "$file" > "${file}.tmp"
                echo "【注意】域名/混合文件已跳过 IP-CIDR 过滤。"
              fi
              
              # 替换原文件，并报告行数
              mv "${file}.tmp" "$file"
              echo "优化后总行数: $(wc -l < "$file")"
            fi
          done

          # =======================================================
          # 5. 提交和推送 (保持不变)
          # =======================================================

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # 添加所有 .list 文件
          git add *.list
          
          # 提交更改 (如果无更改，允许 exit code 0)
          git commit -m "Auto update split rules: $(date +'%Y-%m-%d')" || exit 0
          
          # 推送回仓库
          git push
  workflow-keepalive:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: 保持仓库活跃
        uses: liskin/gh-workflow-keepalive@v1
